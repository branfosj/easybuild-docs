
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.easybuild.io/hooks/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.1, mkdocs-material-8.5.7">
    
    
      
        <title>Hooks - EasyBuild - building software with ease</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="easybuild" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hooks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="EasyBuild - building software with ease" class="md-header__button md-logo" aria-label="EasyBuild - building software with ease" data-md-component="logo">
      
  <img src="../img/easybuild_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EasyBuild - building software with ease
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hooks
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/easybuilders/easybuild-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    EasyBuild @ GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EasyBuild - building software with ease" class="md-nav__button md-logo" aria-label="EasyBuild - building software with ease" data-md-component="logo">
      
  <img src="../img/easybuild_logo.png" alt="logo">

    </a>
    EasyBuild - building software with ease
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/easybuilders/easybuild-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    EasyBuild @ GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../what-is-easybuild/" class="md-nav__link">
        What is EasyBuild?
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../terminology/" class="md-nav__link">
        Terminology
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../using-easybuild/" class="md-nav__link">
        Using EasyBuild
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../release-notes/" class="md-nav__link">
        Release notes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting-help/" class="md-nav__link">
        Getting help
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/easybuilders/easybuild-docs/easybuild-docs/edit/main/docs/hooks.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="hooks">Hooks<a class="headerlink" href="#hooks" title="Permanent link">&para;</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This page will soon replace <a href="https://docs.easybuild.io/en/latest/Hooks.html">https://docs.easybuild.io/en/latest/Hooks.html</a>.</p>
<p><strong>
It still needs to be ported from <em>reStructuredText</em> (.rst) to <em>MarkDown</em> (.md),<br />
and you can help with that!
</strong></p>
<ul>
<li>source: <a href="https://raw.githubusercontent.com/easybuilders/easybuild/develop/docs/Hooks.rst"><code>docs/Hooks.rst</code> in <code>easybuilders/easybuild</code> repo</a></li>
<li>target: <a href="https://github.com/easybuilders/easybuild-docs/tree/main/docs/hooks.md"><code>docs/hooks.md</code> in <code>easybuilders/easybuild-docs</code> repo</a></li>
</ul>
<p>See <a href="https://github.com/easybuilders/easybuild-docs">https://github.com/easybuilders/easybuild-docs</a> for more information.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="p">..</span> <span class="nt">_hooks:</span>

<span class="gh">Hooks</span>
<span class="gh">=====</span>

Since v3.5.0, EasyBuild supports <span class="ge">*hooks*</span> that can be used
to customise the behaviour of EasyBuild according to site policies if needed,
without having to change the EasyBuild framework or the existing easyblocks.

<span class="p">..</span> <span class="ow">contents</span><span class="p">::</span>
    <span class="nc">:depth:</span> 3
    <span class="nc">:backlinks:</span> none

<span class="p">..</span> <span class="nt">_hooks_what:</span>

<span class="gh">What are hooks?</span>
<span class="gh">---------------</span>

<span class="ge">*Hooks*</span> are user-defined functions that are called by the EasyBuild framework at specific times during
the installation procedure. They can be leveraged to alter or augment the installation procedure.

This is usually done to conform with site-specific policies that are difficult to enforce otherwise,
but it can also be (ab)used to fix specific problems or inject self-implemented enhancements
(before you flesh them out in a proper contribution, for example).

Both the <span class="s">``EasyBlock``</span> instance and the parsed easyconfig file that are being used
are fully accessible (and modifiable) from within hook implementations. Hence, this mechanism
provides a lot of flexibility to change the EasyBuild functionality should you require it,
without having to modify the codebase of EasyBuild itself.


<span class="p">..</span> <span class="nt">_hooks_configuration:</span>

<span class="gh">Configuring EasyBuild to use your hook implementations</span>
<span class="gh">------------------------------------------------------</span>

To instruct EasyBuild to use your hook implementations,
you only need to specify the location of the Python module (<span class="s">``*.py``</span>) that implements them.

This is done via the <span class="s">``--hooks``</span> configuration option
(or equivalently via the <span class="s">``$EASYBUILD_HOOKS``</span> environment variable, or via <span class="s">``hooks = ...``</span>
in an EasyBuild configuration file, see also <span class="na">:ref:</span><span class="nv">`configuring_easybuild`</span>).

For example<span class="se">::</span>

<span class="s">    eb --hooks=$HOME/my_eb_hooks.py ...</span>

or<span class="se">::</span>

<span class="s">    export EASYBUILD_HOOKS=$HOME/my_eb_hooks.py</span>
<span class="s">    eb ...</span>


<span class="p">..</span> <span class="nt">_hooks_available:</span>

<span class="gh">Available hooks</span>
<span class="gh">---------------</span>

Currently (since EasyBuild v3.7.0), three types of hooks are supported:

<span class="m">*</span> <span class="s">``start_hook``</span> and <span class="s">``end_hook``</span>, which are triggered <span class="ge">*once*</span> before starting software installations,
  and <span class="ge">*once*</span> right after completing all installations, respectively
<span class="m">*</span> <span class="s">``parse_hook``</span>, which is triggered when an easyconfig file is being parsed
<span class="m">*</span> <span class="s">``module_write_hook``</span>, which is triggered right before a module file is written.
  This includes the temporary module file used when installing extensions and during the sanity check,
  as well as the devel module.
<span class="m">*</span> &quot;<span class="ge">*step*</span>&quot; hooks that are triggered before and after every step of each installation procedure that is performed,
  also aptly named &#39;<span class="s">``pre``</span>&#39;- and &#39;<span class="s">``post``</span>&#39;-hooks

The list of currently available hooks in order of execution,
which can also be consulted using <span class="s">``eb --avail-hooks``</span>, is:

    <span class="m">*</span> <span class="s">``start_hook``</span> <span class="ge">*(only called once in an EasyBuild session)*</span>
    <span class="m">*</span> <span class="s">``parse_hook``</span> <span class="ge">*(available since EasyBuild v3.7.0)*</span>
    <span class="m">*</span> <span class="s">``pre_fetch_hook``</span>, <span class="s">``post_fetch_hook``</span>
    <span class="m">*</span> <span class="s">``pre_ready_hook``</span>, <span class="s">``post_ready_hook``</span>
    <span class="m">*</span> <span class="s">``pre_source_hook``</span>, <span class="s">``post_source_hook``</span>
    <span class="m">*</span> <span class="s">``pre_patch_hook``</span>, <span class="s">``post_patch_hook``</span>
    <span class="m">*</span> <span class="s">``pre_prepare_hook``</span>, <span class="s">``post_prepare_hook``</span>
    <span class="m">*</span> <span class="s">``pre_configure_hook``</span>, <span class="s">``post_configure_hook``</span>
    <span class="m">*</span> <span class="s">``pre_build_hook``</span>, <span class="s">``post_build_hook``</span>
    <span class="m">*</span> <span class="s">``pre_test_hook``</span>, <span class="s">``post_test_hook``</span>
    <span class="m">*</span> <span class="s">``pre_install_hook``</span>, <span class="s">``post_install_hook``</span>
    <span class="m">*</span> <span class="s">``pre_extensions_hook``</span>, <span class="s">``post_extensions_hook``</span>
    <span class="m">*</span> <span class="s">``pre_postproc_hook``</span>, <span class="s">``post_postproc_hook``</span>
    <span class="m">*</span> <span class="s">``pre_sanitycheck_hook``</span>, <span class="s">``post_sanitycheck_hook``</span>
    <span class="m">*</span> <span class="s">``pre_cleanup_hook``</span>, <span class="s">``post_cleanup_hook``</span>
    <span class="m">*</span> <span class="s">``pre_module_hook``</span>, <span class="s">``post_module_hook``</span>
    <span class="m">*</span> <span class="s">``pre_permissions_hook``</span>, <span class="s">``post_permissions_hook``</span>
    <span class="m">*</span> <span class="s">``pre_package_hook``</span>, <span class="s">``post_package_hook``</span>
    <span class="m">*</span> <span class="s">``pre_testcases_hook``</span>, <span class="s">``post_testcases_hook``</span>
    <span class="m">*</span> <span class="s">``end_hook``</span> <span class="ge">*(only called once in an EasyBuild session)*</span>
    <span class="m">*</span> <span class="s">``module_write_hook``</span> <span class="ge">*(called multiple times per installation, available since EasyBuild v4.4.1)*</span>

All functions implemented in the provided Python module for which the name ends with <span class="s">``_hook``</span> are considered.

If any <span class="s">``*_hook``</span> functions are encountered that do not match any of the available hooks, an error is reported.
EasyBuild will try to provide suggestions for available hooks that closely match the encountered unknown hook.

For example<span class="se">::</span>

<span class="s">    $ eb --hooks wrong_hooks.py example.eb</span>
<span class="s">    == temporary log file in case of crash /tmp/eb-nMawy1/easybuild-Gu2ZP6.log</span>
<span class="s">    ERROR: Found one or more unknown hooks:</span>
<span class="s">    * stat_hook (did you mean &#39;start_hook&#39;?)</span>
<span class="s">    * this_is_not_a_hook</span>
<span class="s">    * install_hook (did you mean &#39;pre_install_hook&#39;, or &#39;post_install_hook&#39;?)</span>

<span class="s">    Run &#39;eb --avail-hooks&#39; to get an overview of known hooks</span>

<span class="p">..</span> <span class="nt">_hooks_implementation:</span>

<span class="gh">Implementing hooks</span>
<span class="gh">------------------</span>

To implement hooks, simply define one or more functions in a Python module (<span class="s">``*.py``</span>),
each named after an available hook.

Do take into account the following:

<span class="m">*</span> for <span class="s">``start_hook``</span> and <span class="s">``end_hook``</span>, no arguments are provided

<span class="m">*</span> for <span class="s">``parse_hook``</span>, one argument is provided: the <span class="s">``EasyConfig``</span> instance
  that corresponds to the easyconfig file being parsed (usually referred to as <span class="s">``ec``</span>)

<span class="m">*</span> for <span class="s">``module_write_hook``</span>, 3 arguments are provided:
   <span class="m">*</span> the <span class="s">``EasyBlock``</span> instance used to perform the installation (usually referred to as <span class="s">``self``</span>)
   <span class="m">*</span> the filepath of the module that will be written
   <span class="m">*</span> the module text as a string
  The return value of this hook, when set, will replace the original text that is then written to the module file.

<span class="m">*</span> for the step hooks, one argument is provided:
  the <span class="s">``EasyBlock``</span> instance used to perform the installation (usually referred to as <span class="s">``self``</span>)

<span class="m">*</span> the parsed easyconfig file can be accessed in the step hooks via the <span class="s">``EasyBlock``</span> instance,
  i.e., via <span class="s">``self.cfg``</span>

It is recommended to anticipate possible changes in the provided (named) arguments,
using the <span class="s">``*args``</span> and <span class="s">``**kwargs``</span> mechanism commonly used in Python. This
avoids that your hook implementations may break when updating to future EasyBuild versions. For example<span class="se">::</span>

<span class="s">  # example pre-configure hook that anticipates changes in provided arguments</span>
<span class="s">  def pre_configure_hook(self, *args, **kwargs):</span>
<span class="s">      ...</span>

In hooks you have access to the full functionality provided by the EasyBuild framework,
so do <span class="s">``import``</span> from <span class="s">``easybuild.tools.*``</span> (or other <span class="s">``easybuild.*``</span> namespaces) to leverage
those functions.

<span class="p">..</span> <span class="nt">_hooks_parse_hook:</span>

<span class="gh">Parse hook specifics</span>
<span class="gh">++++++++++++++++++++</span>

<span class="s">``parse_hook``</span> is triggered right <span class="ge">*after*</span> reading the easyconfig file,
before further parsing of some easyconfig parameters (like <span class="s">``*dependencies``</span>) into
custom data structures is done.

This is important since it allows to dynamically modify easyconfig files
while they are still &quot;raw&quot;, i.e. when the easyconfig parameter values are
still basic Python data structures like lists, dictionaries, etc.
that are easy to manipulate (see also <span class="na">:ref:</span><span class="nv">`hooks_caveats_manipulating`</span>).

In <span class="s">``parse_hook``</span> easyconfig parameters can be accessed and/or modified in a straightforward way,
see <span class="na">:ref:</span><span class="nv">`hooks_examples_inject_patch`</span>.


<span class="p">..</span> <span class="nt">_hooks_caveats:</span>

<span class="gh">Caveats</span>
<span class="gh">-------</span>

Due to internal details of the EasyBuild framework, you may run into some surprises when
implementing hooks.
Here are some things to take into account:

<span class="p">..</span> <span class="nt">_hooks_caveats_template_values:</span>

<span class="gh">Resolving of template values</span>
<span class="gh">++++++++++++++++++++++++++++</span>

In all <span class="ge">*step*</span> hooks, template values in easyconfig parameters will be resolved whenever they are accessed.

That is, if the <span class="s">``%(version)``</span> template is used in for example the <span class="s">``sources``</span> easyconfig parameter,
it will be replaced with the actual value of the <span class="s">``version``</span> easyconfig parameter whenever the
<span class="s">``sources``</span> value is used.
This can be avoided by temporarily disabling templating by wrapping the code in <span class="s">``with self.cfg.disable_templating:``</span>.

There is one notable exception to this:
Templates in easyconfig parameters are <span class="ge">*not*</span> resolved in <span class="s">``parse_hook``</span>,
because templating has been disabled explicitly before <span class="s">``parse_hook``</span> is called;
this helps significantly to simplify manipulating of easyconfig parameter values
(see also <span class="na">:ref:</span><span class="nv">`hooks_caveats_manipulating`</span>).


<span class="p">..</span> <span class="nt">_hooks_caveats_manipulating:</span>

<span class="gh">Manipulating easyconfig parameters</span>
<span class="gh">++++++++++++++++++++++++++++++++++</span>

You may run into surprises when trying to manipulate easyconfig parameters, for various reasons.

First of all, the original easyconfig parameters may already be processed in another data structure
which does not resemble the original format in which the parameter was defined in the easyconfig file.

Moreover, this processing could be done either &quot;in place&quot; by replacing the original easyconfig parameter value,
or in a separate variable, which effectively means that any changes to the original easyconfig parameter value
are simply ignored.

In addition, because of how the templating mechanism for easyconfig parameter works,
changes to easyconfig parameters with non-string values (i.e. lists, dictionaries, etc.) will go up
in smoke if not done correctly.

More specifically, the following approach will <span class="ge">*not*</span> work in any of the (step) hooks, except for <span class="s">``parse_hook``</span>:

<span class="p">..</span> <span class="ow">code</span><span class="p">::</span> <span class="k">python</span>

    <span class="k">def</span> <span class="nf">pre_fetch_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Example of pre-fetch hook to manipulate list of patches.&quot;</span>
        <span class="c1"># this does NOT have the intended affect in any pre- or post-step hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;patches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;example.patch&#39;</span><span class="p">)</span>

The problem here is that the value obtained via <span class="s">``self.cfg[&#39;patches&#39;]``</span> is not a reference
to the actual easyconfig parameter value but a reference to a temporary copy thereof;
hence any updates on the copy are effectively lost immediately.

To achieve the intended effect, you can either:

<span class="m">*</span> temporarily disable the templating mechanism:

<span class="p">  ..</span> <span class="ow">code</span><span class="p">::</span> python

    def pre_fetch_hook(self):
        &quot;Example of pre-fetch hook to manipulate list of patches.&quot;
        # temporarily disable templating, so changes to &#39;patches&#39; easyconfig parameter are picked up
        with self.cfg.disable_templating:
            # add patch
            self.cfg[&#39;patches&#39;].append(&#39;example.patch&#39;)
        # templating state restored

<span class="m">*</span> or replace the original value entirely:

<span class="p">  ..</span> <span class="ow">code</span><span class="p">::</span> python

    def pre_fetch_hook(self):
        &quot;Example of pre-fetch hook to manipulate list of patches.&quot;
        self.cfg[&#39;patches&#39;] = self.cfg[&#39;patches&#39;] + [&#39;example.patch&#39;]


A better approach for manipulating easyconfig parameters is to use the <span class="s">``parse_hook``</span> that
was introduced in EasyBuild v3.7.0 (see <span class="na">:ref:</span><span class="nv">`hooks_parse_hook`</span>),
where these kind of surprises will not occur (because templating is automatically disabled
before <span class="s">``parse_hook``</span> is called and restored immediately afterwards).
See also <span class="na">:ref:</span><span class="nv">`hooks_examples_inject_patch`</span>.

<span class="p">..</span> <span class="nt">_hooks_caveats_archived_easyconfig:</span>

<span class="gh">Archived easyconfig file vs hooks</span>
<span class="gh">+++++++++++++++++++++++++++++++++</span>

EasyBuild archives the easyconfig file that was used for a particular installation:
A copy is stored both in the <span class="s">``easybuild``</span> subdirectory of the software installation
directory and in the easyconfigs repository (see <span class="na">:ref:</span><span class="nv">`easyconfigs_repo`</span>).

If any changes were made to the easyconfig file via hooks, these changes will <span class="ge">*not*</span> be
reflected in these copies.
The assumption here is that the hooks will also be in place for future (re-)installations.

EasyBuild does however store an additional copy of the easyconfig file which includes
any modifications that were done dynamically, for example by hooks.
If subtoolchains were used to resolve dependencies, they will also be hardwired in this copy.

This &quot;<span class="ge">*reproducible easyconfig*</span>&quot; is stored in the <span class="s">``easybuild/reprod``</span> subdirectory
of the software installation directory.


<span class="p">..</span> <span class="nt">_hooks_examples:</span>

<span class="gh">Examples of hook implementations</span>
<span class="gh">--------------------------------</span>

<span class="p">..</span> <span class="nt">_hooks_examples_openmpi_configopts:</span>

<span class="gh">Example hook to replace ``--with-verbs`` with ``--without-verbs`` in OpenMPI configure options</span>
<span class="gh">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="p">..</span> <span class="ow">code</span><span class="p">::</span> <span class="k">python</span>

    <span class="k">def</span> <span class="nf">pre_configure_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Example pre-configure hook to replace --with-verbs with --without -verbs for OpenMPI.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;OpenMPI&#39;</span> <span class="ow">and</span> <span class="s1">&#39;--with-verbs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;configopts&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[pre-configure hook] Replacing --with-verbs with --without-verbs&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;configopts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;configopts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;--with-verbs&#39;</span><span class="p">,</span> <span class="s1">&#39;--without-verbs&#39;</span><span class="p">)</span>

<span class="p">..</span> <span class="nt">_hooks_examples_inject_patch:</span>

<span class="gh">Example hook to inject a custom patch file</span>
<span class="gh">++++++++++++++++++++++++++++++++++++++++++</span>

<span class="p">..</span> <span class="ow">code</span><span class="p">::</span> <span class="k">python</span>

    <span class="k">def</span> <span class="nf">parse_hook</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Example parse hook to inject a patch file for a fictive software package named &#39;Example&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ec</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Example&#39;</span><span class="p">:</span>
            <span class="n">patch_file</span> <span class="o">=</span> <span class="s1">&#39;example.patch&#39;</span>
            <span class="n">ec</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[parse hook] Injecting additional patch file &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">patch_file</span><span class="p">)</span>
            <span class="n">ec</span><span class="p">[</span><span class="s1">&#39;patches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch_file</span><span class="p">)</span>

<span class="gh">Example hook to replace PYTHONPATH by EBPYTHONPREFIXES in (Lua) modules</span>
<span class="gh">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="p">..</span> <span class="ow">code</span><span class="p">::</span> <span class="k">python</span>

    <span class="k">def</span> <span class="nf">module_write_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">module_txt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># note: if `self.mod_filepath == filepath` =&gt; final module file</span>
        <span class="k">if</span> <span class="s1">&#39;Python&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()):</span>
            <span class="n">search</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;prepend_path\(&quot;PYTHONPATH&quot;, pathJoin\(root, &quot;lib/python\d.\d/site-packages&quot;\)\)&#39;</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="s1">&#39;prepend_path(&quot;EBPYTHONPREFIXES&quot;, root)&#39;</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">search</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span> <span class="n">module_txt</span><span class="p">)</span>
</code></pre></div>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 24, 2022</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/easy_build" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://www.youtube.com/c/easybuilders" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://docs.easybuild.io" target="_blank" rel="noopener" title="docs.easybuild.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M96 0C43 0 0 43 0 96v320c0 53 43 96 96 96h320c17.7 0 32-14.3 32-32s-14.3-32-32-32v-64c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32H96zm0 384h256v64H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32-240c0-8.8 7.2-16 16-16h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16zm16 48h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["instant"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8492ddcf.min.js"></script>
      
    
  </body>
</html>